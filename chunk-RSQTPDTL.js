import{Fa as h,Ja as g,Ka as U,Ua as E,Va as w,ab as I,bb as y,cb as b,db as v,eb as _,hb as S,j as f,m as d}from"./chunk-3IBPSVRT.js";import{a as l,b as m,f as N,g as c,h as u}from"./chunk-ENRHZQ2S.js";var x={userId:"user_id",password:"passwd",branchName:"branch_name"},e=class extends g{userId="";password="";branchName="";plainPassword="";constructor(){super(),this._mapper=new y(x)}getPrimaryKeyName(){return"userId"}getSoftDelete(){}};c([v("user_id")],e.prototype,"userId",2),c([_()],e.prototype,"plainPassword",2),e=c([b("usermst")],e);var p=N(E());var n="auth_user",P=class a extends I{constructor(r,s){super(r,e);this.router=s;let o=localStorage.getItem(n);if(o)try{let t=atob(o),i=JSON.parse(t);this._currentUser=e.create(e,i),this._currentUser.plainPassword=i.plainPassword}catch(t){console.warn("Failed to decode stored user:",t),this._currentUser=null}}_currentUser=null;getName(){return"users"}login(r,s){return u(this,null,function*(){let o="Wrong username/password combination",t=yield this.find(r);if(!t||t.password!==(0,p.sha256)(s))throw new Error(o);this._currentUser=t,this._currentUser.plainPassword=s;let i=btoa(JSON.stringify(m(l({},t.toJson()),{plainPassword:this._currentUser.plainPassword})));return localStorage.setItem(n,i),t})}logout(){this._currentUser=null,localStorage.removeItem(n),localStorage.removeItem("tsway.setting.store"),localStorage.removeItem("tsway.branch.store"),this.router.navigate(["/auth"])}authUser(){if(this._currentUser)return this._currentUser;let r=localStorage.getItem(n);if(r)try{let s=atob(r),o=JSON.parse(s);return this._currentUser=e.create(e,o),this._currentUser.plainPassword=o.plainPassword,this._currentUser}catch(s){console.warn("Failed to decode stored user:",s),localStorage.removeItem(n)}}verifySession(){return u(this,null,function*(){if(!this._currentUser?.userId||!this._currentUser?.plainPassword){this.logout();return}try{let r=yield this.find(this._currentUser.userId);(!r||r.password!==(0,p.sha256)(this._currentUser.plainPassword))&&this.logout()}catch(r){console.error("Session verification failed:",r),this.logout()}})}verifyUserIsUnique(r){return u(this,null,function*(){let o=this.getQueryBuilder().select(["userId"]).where("userId",U(r.userId)).buildParameterized(),t=w(o);return yield this.http.post(this.url(),t).then(i=>this.parseResponse(i).length===0)})}static \u0275fac=function(s){return new(s||a)(d(S),d(h))};static \u0275prov=f({token:a,factory:a.\u0275fac,providedIn:"root"})};export{e as a,P as b};
