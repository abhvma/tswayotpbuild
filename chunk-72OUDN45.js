import{b as ke,c as Ke}from"./chunk-GOJTA3EC.js";import{c as _e}from"./chunk-PPYA3SWL.js";import{b as P}from"./chunk-32H7AQ3L.js";import{a as J}from"./chunk-VMBGR2WL.js";import{b as Fe}from"./chunk-LWG7IUOX.js";import{b as A,c as y,d as Te}from"./chunk-6WJF7NL3.js";import{a as H,c as Ee}from"./chunk-7VL2AYZC.js";import{a as L}from"./chunk-HVPVQXOI.js";import{a as Q,c as F}from"./chunk-ZGLSKZPV.js";import{A as G,B as b,Ba as z,C as v,E as oe,F as _,Fa as fe,Fb as E,Ga as ge,Gb as d,Hb as T,Ia as ye,Ib as w,Kb as N,Lb as M,Mb as x,N as ae,Nb as V,O as s,Ob as q,Pb as I,Qb as D,S as f,Ta as he,Tb as R,Ua as Se,V as O,Vb as Oe,W as le,Z as se,_ as me,ba as l,eb as be,fa as n,ga as i,gb as S,ha as u,ia as pe,ib as U,ja as de,jb as j,ka as $,la as c,ma as K,sb as ie,ta as ue,tb as ve,ua as o,ub as Ce,v as ne,va as ce}from"./chunk-Y6X5IISN.js";import{a as k,b as te,h}from"./chunk-ENRHZQ2S.js";var W=class p{constructor(m,e,t){this.fb=m;this.toast=e;this.serialKeyService=t;this.userForm=this.fb.group({otptype:[2,d.required],count:[1,[d.required,d.min(1),d.max(1e4)]],branch_cd:[void 0,d.required],bank_cd:[void 0,d.required],command:[3],from:[1],status:[0]}),this.userForm.get("otptype")?.valueChanges.subscribe(r=>{this.user&&this.setting&&this.serialKeyService.getLastMaxCount(this.setting.bankCode,this.user.branchName,this.userForm.get("otptype").value).then(a=>{this.lastMaxCount=a})})}user;setting;save=new _;cancel=new _;lastMaxCount;modalTitle="Generate Keys";userForm;eOtpType=F;dialogRef;userNotUnique=!1;ngOnChanges(){this.user&&this.userForm.get("branch_cd").setValue(this.user.branchName),this.setting&&this.userForm.get("bank_cd").setValue(this.setting.bankCode),this.user&&this.setting&&this.serialKeyService.getLastMaxCount(this.setting.bankCode,this.user.branchName,this.userForm.get("otptype").value).then(m=>{this.lastMaxCount=m})}onSave(){return h(this,null,function*(){let m=new L;try{m.show();let e=k({},this.userForm.value);e.from=this.lastMaxCount,e.to=+e.count+ +e.from,delete e.count,yield this.serialKeyService.generateKey(e),this.dialogRef.close(void 0),this.toast.success(`${this.userForm.get("count")?.value} key${this.userForm.value.count>1?"s":""} generated successfully.`)}catch(e){this.toast.error(e.msg)}finally{m.hide()}})}onCancel(){this.dialogRef.close(void 0),this.cancel.emit()}get formControls(){return this.userForm.controls}static \u0275fac=function(e){return new(e||p)(f(R),f(H),f(y))};static \u0275cmp=O({type:p,selectors:[["app-otp-serial-key-create-modal"]],inputs:{user:"user",setting:"setting"},outputs:{save:"save",cancel:"cancel"},standalone:!1,features:[z([P,y]),G],decls:30,vars:5,consts:[[1,"modal-content",3,"formGroup"],[1,"tsway-modal-header"],[1,"tsway-modal-title"],["type","button","aria-label","Close",1,"btn-close",3,"click"],[1,"tsway-modal-body"],[1,"row"],[1,"col-md"],["for","otptype",1,"form-label","small","mb-1"],["id","otptype","formControlName","otptype",1,"form-control"],[3,"ngValue"],["for","count",1,"form-label","small","mb-1"],["type","number","formControlName","count","id","count",1,"form-control"],["role","alert",1,"alert","alert-info","alert-sm","py-1","px-2","mb-2","mt-2"],[1,"small","mb-0"],[1,"bi","bi-info-circle-fill","me-2"],[1,"tsway-modal-footer","d-flex","flex-row-reverse","justify-content-start"],[1,"btn","btn-primary",3,"click","disabled"],[1,"btn","btn-danger","me-2","text-white",3,"click"]],template:function(e,t){e&1&&(n(0,"form",0)(1,"div",1)(2,"h5",2),o(3,"Generate Key"),i(),n(4,"button",3),c("click",function(){return t.onCancel()}),i()(),n(5,"div",4)(6,"div",5)(7,"section",6)(8,"label",7),o(9,"Type"),i(),n(10,"select",8)(11,"option",9),o(12,"Card"),i(),n(13,"option",9),o(14,"Token"),i()()(),n(15,"section",6)(16,"label",10),o(17,"Number of Key to generate?"),i(),u(18,"input",11),i()(),n(19,"div",12)(20,"p",13),u(21,"i",14),o(22," Last sequence number issued: "),n(23,"strong"),o(24),i()()()(),n(25,"div",15)(26,"button",16),c("click",function(){return t.onSave()}),o(27," Save "),i(),n(28,"button",17),c("click",function(){return t.onCancel()}),o(29," Cancel "),i()()()),e&2&&(l("formGroup",t.userForm),s(11),l("ngValue",t.eOtpType.Card),s(2),l("ngValue",t.eOtpType.Token),s(11),ce(t.lastMaxCount),s(2),l("disabled",t.userForm.invalid))},dependencies:[N,I,D,E,M,q,T,w,x,V],styles:["[_nghost-%COMP%]{font-size:.875rem!important}"]})};var Y=class p{constructor(m,e,t){this.fb=m;this.toast=e;this.serialKeyService=t;this.form=this.fb.group({otptype:[2,d.required],branch_cd:[void 0,d.required],bank_cd:[void 0,d.required],command:[3],from:[1,[d.required,d.min(1)]],to:[1,[d.required,d.min(1),d.max(1e4)]],status:[0]}),this.form.get("otptype")?.valueChanges.subscribe(r=>{this.user&&this.setting&&this.getRanges(r)})}user;setting;status=1;otpType=2;save=new _;cancel=new _;dialogRef;modalTitle="Generate Keys";form;eOtpType=F;eStatus=A;userNotUnique=!1;getRanges(m){this.serialKeyService.getRangesForStatus(this.setting.bankCode,this.user.branchName,m,this.status===1?0:1).then(e=>{e.length>0?(this.form.get("from")?.setValue(e[0]),this.form.get("to")?.setValue(e[1])):(this.form.get("from")?.setValue(1),this.form.get("to")?.setValue(1))})}ngOnChanges(){this.user&&this.form.get("branch_cd").setValue(this.user.branchName),this.setting&&this.form.get("bank_cd").setValue(this.setting.bankCode),this.user&&this.setting&&this.getRanges(this.form.get("otptype").value),this.form.get("status")?.setValue(this.status),this.form.get("otptype")?.setValue(this.otpType)}onSave(){return h(this,null,function*(){let m=new L;try{let e;m.show();let t=k({},this.form.value);if(e=yield this.serialKeyService.get([{bankCode:S(t.bank_cd)},{branchCode:S(t.branch_cd)},{sequenceNumber:U(t.from)},{sequenceNumber:j(t.to)},{otpType:S(t.otptype)},{status:S(this.status===1?0:1)}]),e.length===0){this.toast.warning(`No data found in the range of [${t.from},${t.to}]`);return}let r;t.status===this.eStatus.Registered?r=this.serialKeyService.sendForManufacturing(t.bank_cd,t.branch_cd,t.from,t.to):r=this.serialKeyService.markAsDelivered(t.bank_cd,t.branch_cd,t.from,t.to),yield r,e.forEach(a=>{a.status=this.status}),this.dialogRef.close(e),this.toast.success(`Serial Key from ${t.from} to ${t.to} updated to ${t.status===this.eStatus.Registered?"Registered":"Enrolled"} successfully.`)}catch(e){this.toast.error(e.msg)}finally{m.hide()}})}onCancel(){this.dialogRef.close(void 0),this.cancel.emit()}get formControls(){return this.form.controls}static \u0275fac=function(e){return new(e||p)(f(R),f(H),f(y))};static \u0275cmp=O({type:p,selectors:[["app-otp-serial-key-create-modal"]],inputs:{user:"user",setting:"setting",status:"status",otpType:"otpType"},outputs:{save:"save",cancel:"cancel"},standalone:!1,features:[z([y]),G],decls:33,vars:7,consts:[[1,"modal-content",3,"formGroup"],[1,"tsway-modal-header"],[1,"tsway-modal-title"],["type","button","aria-label","Close",1,"btn-close",3,"click"],[1,"tsway-modal-body"],[1,"row"],[1,"col-md-12"],["for","otptype",1,"form-label","small","mb-1"],["id","otptype","formControlName","otptype",1,"form-control"],[3,"ngValue"],["for","from",1,"form-label","small","mb-1"],["type","number","formControlName","from","id","from",1,"form-control"],["for","to",1,"form-label","small","mb-1"],["type","number","formControlName","to","id","to",1,"form-control"],["for","status",1,"form-label","small","mb-1","d-block"],[1,"form-control","d-block",3,"innerHTML"],[1,"tsway-modal-footer","d-flex","flex-row-reverse","justify-content-start"],[1,"btn","btn-primary",3,"click","disabled"],[1,"btn","btn-danger","me-2","text-white",3,"click"]],template:function(e,t){e&1&&(n(0,"form",0)(1,"div",1)(2,"h5",2),o(3,"Bulk Update"),i(),n(4,"button",3),c("click",function(){return t.onCancel()}),i()(),n(5,"div",4)(6,"div",5)(7,"section",6)(8,"label",7),o(9,"Type"),i(),n(10,"select",8)(11,"option",9),o(12,"Card"),i(),n(13,"option",9),o(14,"Token"),i()()(),n(15,"section",6)(16,"label",10),o(17,"Sequence Number Start"),i(),u(18,"input",11),i(),n(19,"section",6)(20,"label",12),o(21,"Sequence Number End"),i(),u(22,"input",13),i(),n(23,"section",6)(24,"span",14),o(25,"Status"),i(),u(26,"span",15),fe(27,"serialNumberStatus"),i()()(),n(28,"div",16)(29,"button",17),c("click",function(){return t.onSave()}),o(30," Save "),i(),n(31,"button",18),c("click",function(){return t.onCancel()}),o(32," Cancel "),i()()()),e&2&&(l("formGroup",t.form),s(11),l("ngValue",t.eOtpType.Card),s(2),l("ngValue",t.eOtpType.Token),s(13),l("innerHTML",ge(27,5,t.status),ae),s(3),l("disabled",t.form.invalid))},dependencies:[N,I,D,E,M,q,T,w,x,V,ke],styles:["[_nghost-%COMP%]{font-size:.875rem!important}"]})};var Z=class p{constructor(m){this.fb=m;let e=new Q().date();this.filterForm=this.fb.group({type:[this.eSerialType.Card],dateFrom:[e,d.required],dateTo:[e,d.required],status:[this.eStatusType.Created],sequenceStart:[],sequenceEnd:[]}),this.dateFrom=this.filterForm.get("dateFrom"),this.dateTo=this.filterForm.get("dateTo")}filterChange=new _;filterForm;eSerialType=F;eStatusType=A;dateFrom;dateTo;onSubmit(){this.filterChange.emit({type:this.filterForm.get("type").value,dateTo:this.dateFrom.value?new Q(this.dateTo.value):void 0,dateFrom:this.dateTo.value?new Q(this.dateFrom.value):void 0,status:ve(this.filterForm.get("status").value)?-1:this.filterForm.get("status").value,sequenceStart:this.filterForm.get("sequenceStart").value?this.filterForm.get("sequenceStart").value:void 0,sequenceEnd:this.filterForm.get("sequenceEnd").value?this.filterForm.get("sequenceEnd").value:void 0})}ngOnDestroy(){}static \u0275fac=function(e){return new(e||p)(f(R))};static \u0275cmp=O({type:p,selectors:[["app-serial-key-filterbar"]],outputs:{filterChange:"filterChange"},standalone:!1,decls:44,vars:9,consts:[[1,"filterbar","mb-3"],[1,"row","g-3","align-items-end",3,"formGroup"],[1,"col-md"],["for","type",1,"form-label","small","mb-1"],["id","type","formControlName","type",1,"form-control"],[3,"ngValue"],["for","sequenceStart",1,"form-label","small","mb-1"],["type","number","id","sequenceStart","formControlName","sequenceStart",1,"form-control"],["for","sequenceEnd",1,"form-label","small","mb-1"],["type","number","id","sequenceEnd","formControlName","sequenceEnd",1,"form-control"],["for","dateFrom",1,"form-label","small","mb-1"],["type","date","id","dateFrom","formControlName","dateFrom",1,"form-control"],["for","dateTo",1,"form-label","small","mb-1"],["type","date","id","dateTo","formControlName","dateTo",1,"form-control"],["for","status",1,"form-label","small","mb-1"],["id","status","formControlName","status",1,"form-control"],[1,"col-auto"],[1,"btn","btn-primary","w-100","d-flex","align-items-center","justify-content-center","gap-2",3,"click","disabled"],[1,"bi","bi-search"]],template:function(e,t){e&1&&(n(0,"div",0)(1,"form",1)(2,"div",2)(3,"label",3),o(4,"Type"),i(),n(5,"select",4)(6,"option",5),o(7,"Card"),i(),n(8,"option",5),o(9,"Token"),i()()(),n(10,"div",2)(11,"label",6),o(12,"Sequence Start"),i(),u(13,"input",7),i(),n(14,"div",2)(15,"label",8),o(16,"Sequence End"),i(),u(17,"input",9),i(),n(18,"div",2)(19,"label",10),o(20,"From*"),i(),u(21,"input",11),i(),n(22,"div",2)(23,"label",12),o(24,"To*"),i(),u(25,"input",13),i(),n(26,"div",2)(27,"label",14),o(28,"Status"),i(),n(29,"select",15)(30,"option",5),o(31,"Created"),i(),n(32,"option",5),o(33,"Registered"),i(),n(34,"option",5),o(35,"Enrolled"),i(),n(36,"option",5),o(37,"Active"),i(),n(38,"option",5),o(39,"Revoked"),i()()(),n(40,"div",16)(41,"button",17),c("click",function(){return t.onSubmit()}),u(42,"i",18),o(43," Search "),i()()()()),e&2&&(s(),l("formGroup",t.filterForm),s(5),l("ngValue",t.eSerialType.Card),s(2),l("ngValue",t.eSerialType.Token),s(22),l("ngValue",t.eStatusType.Created),s(2),l("ngValue",t.eStatusType.Registered),s(2),l("ngValue",t.eStatusType.Enrolled),s(2),l("ngValue",t.eStatusType.Active),s(2),l("ngValue",t.eStatusType.Revoked),s(3),l("disabled",t.filterForm.invalid))},dependencies:[N,I,D,E,M,q,T,w,x,V],encapsulation:2})};function Ie(p,m){if(p&1){let e=$();pe(0),n(1,"app-otp-serial-key-table",14),c("sendForManufacturingAction",function(r){b(e);let a=K();return v(a.onSendForManufacturing(r))})("markAsDeliveredAction",function(r){b(e);let a=K();return v(a.onMarkAsDelivered(r))}),i(),de()}if(p&2){let e=K();s(),l("models",e.models)}}function De(p,m){if(p&1){let e=$();n(0,"div",15)(1,"app-paginator",16),c("pageChange",function(r){b(e);let a=K();return v(a.onPageChange(r))})("pageSizeChange",function(r){b(e);let a=K();return v(a.onPageSizeChange(r))}),i()()}if(p&2){let e=K();s(),l("currentPage",e.paginationOption.currentPage)("pageSize",e.paginationOption.pageSize)("total",e.paginationOption.total)("startPage",1)("totalNotKnown",!1)}}function Re(p,m){p&1&&(n(0,"div",17)(1,"div"),u(2,"i",18),n(3,"p",4),o(4,"Key records not found."),i()()())}var ee=class p extends Fe{constructor(e,t,r,a){super(a);this.authService=t;this.settingService=r;this.modelService=e}setting;user;hasSearched=!1;startSequence=1;endSequence=1;getFilterParams(){let e=[],t=this.modelFilters;return t.type&&e.push({otpType:S(t.type)}),Number(t.status)>-1&&e.push({status:S(t.status)}),t.dateFrom&&e.push({createdDate:U(t.dateFrom.date(!0))}),t.dateTo&&e.push({createdDate:j(t.dateTo.date(!1))}),t.sequenceStart&&e.push({sequenceNumber:U(t.sequenceStart)}),t.sequenceEnd&&e.push({sequenceNumber:j(t.sequenceEnd)}),e.push({bankCode:S(this.setting.bankCode)}),e.push({branchCode:S(this.user.branchName)}),e}ngOnInit(){this.settingService.find().then(e=>{this.setting=e}),this.user=this.authService.authUser()}getOrder(){return{sequenceNumber:"ASC"}}applyFilters(){return h(this,null,function*(){this.hasSearched=!0,this.paginationOption=te(k({},this.paginationOption),{startPage:0,currentPage:0}),this.paginationOption.total=yield this.modelService.getCount(this.getFilterParams()),yield this.loadModels(!0)})}openDialog(e){return h(this,null,function*(){(yield this.dialog.open(W,{user:this.user,setting:this.setting},{width:"35%"})).closed.subscribe(r=>{})})}loadModels(e){return super.loadModels(e).then(t=>(t.length>0&&(this.startSequence=t[0].sequenceNumber,this.endSequence=t[t.length-1].sequenceNumber),t))}onPageChange(e){this.paginationOption=te(k({},this.paginationOption),{currentPage:e}),this.loadModels(!0)}onPageSizeChange(e){this.paginationOption.pageSize=e}onSendForManufacturing(e){return h(this,null,function*(){if(yield this.alert.show("Confirm Action","Are you sure you want to send these items for registration?","primary")){let r=!1,a=ie(e.map(g=>g.sequenceNumber));for(let g of a)try{yield this.modelService.sendForManufacturing(this.setting.bankCode,this.user.branchName,g.start,g.end),this.loadModels().then(),r=!0,this.toast.success(`Serial Key from ${g.start} to ${g.end} updated to registered successfully.`)}catch{r=!1,this.toast.error("Update status change failed.")}r&&this.downloadKeySerial(e)}})}onMarkAsDelivered(e){return h(this,null,function*(){if(yield this.alert.show("Confirm Action","Are you sure you want to send these items as enrolled?","primary")){let r=ie(e.map(a=>a.sequenceNumber));for(let a of r)try{yield this.modelService.markAsDelivered(this.setting.bankCode,this.user.branchName,a.start,a.end),this.loadModels().then(),this.toast.success(`Serial Keys from ${a.start} to ${a.end} updated to enrolled successfully.`)}catch{this.toast.error("Update status change failed.")}}})}downloadKeySerial(e){let t=[];t.push("SerialNumber,OtpKey"),e.forEach(B=>{let xe=Ce(B.bankCode,B.branchCode,B.sequenceNumber+"");t.push(`${xe},${B.otpKey}`)});let r=t.join(`
`),a=new Blob([r],{type:"text/csv;charset=utf-8;"}),g=window.URL.createObjectURL(a),C=document.createElement("a");C.href=g,C.setAttribute("download",`${e[0].otpType===2?"card":"token"}-otp-keys.csv`),document.body.appendChild(C),C.click(),document.body.removeChild(C),window.URL.revokeObjectURL(g)}onBulkUpdateClick(){return h(this,null,function*(){let e=this.getBulkUpdateDisableState().allCreated?1:2;(yield this.dialog.open(Y,{status:e,user:this.user,setting:this.setting,otpType:this.modelFilters.type||2},{width:"30%"})).closed.subscribe(r=>{r&&r.length>0&&(this.loadModels(!0).then(),e===1&&this.downloadKeySerial(r))})})}downloadCSVForSearchResult(){return h(this,null,function*(){this.models.length>0&&this.downloadKeySerial(this.models)})}getBulkUpdateDisableState(){if(this.models.length===0)return{allCreated:!1,allManufacturing:!1,disabled:!0};let e=this.models.every(r=>r.status===0),t=this.models.every(r=>r.status===1);return this.modelFilters.status===0&&e?{allCreated:!0,allManufacturing:!1,disabled:!1}:this.modelFilters.status===1&&t?{allCreated:!1,allManufacturing:!0,disabled:!1}:{allCreated:!1,allManufacturing:!1,disabled:!0}}static \u0275fac=function(t){return new(t||p)(f(y),f(_e),f(P),f(oe))};static \u0275cmp=O({type:p,selectors:[["app-serial-key"]],standalone:!1,features:[se],decls:20,vars:5,consts:[["button",""],["noData",""],[1,"container-fluid","py-4","d-flex","flex-column","vh-100"],[1,"d-flex","justify-content-between","align-items-center","mb-4"],[1,"mb-0"],[1,"btn","btn-danger","text-white",3,"click"],[1,"bi","bi-plus-lg","me-1"],[3,"filterChange"],[1,"d-flex","justify-content-end","mb-2"],["role","button",1,"btn","btn-small","btn-link","text-muted","small","text-decoration-none",3,"click","disabled"],[1,"bi","bi-journals","me-1"],[1,"bi","bi-download","me-1"],[4,"ngIf","ngIfElse"],["class","mb-4 fixed",4,"ngIf"],[3,"sendForManufacturingAction","markAsDeliveredAction","models"],[1,"mb-4","fixed"],[3,"pageChange","pageSizeChange","currentPage","pageSize","total","startPage","totalNotKnown"],[1,"d-flex","justify-content-center","align-items-center","h-100","text-muted","text-center","px-4"],[1,"bi","bi-search","display-6","d-block","mb-2"]],template:function(t,r){if(t&1){let a=$();n(0,"div",2)(1,"div",3)(2,"h2",4),o(3,"Cards & Tokens"),i(),n(4,"button",5,0),c("click",function(){return b(a),v(r.addModel())}),u(6,"i",6),o(7,"Create "),i()(),n(8,"app-serial-key-filterbar",7),c("filterChange",function(C){return b(a),v(r.onFilterChange(C))}),i(),n(9,"div",8)(10,"button",9),c("click",function(){return b(a),v(r.onBulkUpdateClick())}),u(11,"i",10),o(12," Bulk Update "),i(),n(13,"button",9),c("click",function(){return b(a),v(r.downloadCSVForSearchResult())}),u(14,"i",11),o(15," Download CSV"),i()(),me(16,Ie,2,1,"ng-container",12)(17,De,2,5,"div",13)(18,Re,5,0,"ng-template",null,1,ye),i()}if(t&2){let a=ue(19);s(10),l("disabled",r.getBulkUpdateDisableState().disabled),s(3),l("disabled",r.models.length===0),s(3),l("ngIf",r.models.length>0)("ngIfElse",a),s(),l("ngIf",r.hasSearched)}},dependencies:[Ke,he,J,Z],encapsulation:2})};var Pe=[{path:"",component:ee}],Me=class p{static \u0275fac=function(e){return new(e||p)};static \u0275mod=le({type:p});static \u0275inj=ne({providers:[P,y],imports:[Te,Se,be.forChild(Pe),Oe,Ee,J]})};export{Me as OtpSerialKeyModule};
