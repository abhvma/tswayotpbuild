import{b as _e,c as Oe}from"./chunk-JDCEVTP2.js";import{c as ve}from"./chunk-PPYA3SWL.js";import{b as D}from"./chunk-32H7AQ3L.js";import{a as J}from"./chunk-QM4LAV73.js";import{b as ke}from"./chunk-CFOUEXOU.js";import{b as A,c as y,d as Fe}from"./chunk-4MZHQOIT.js";import{a as H,c as Ke}from"./chunk-7VL2AYZC.js";import{a as $}from"./chunk-HVPVQXOI.js";import{a as Q,c as P}from"./chunk-ZGLSKZPV.js";import{A as G,B as h,Ba as L,C as b,E as ne,F as C,Fa as de,Fb as K,Ga as ce,Gb as u,Hb as F,Ia as fe,Ib as E,Kb as w,Lb as T,Mb as M,N as ae,Nb as N,O as s,Ob as x,Pb as q,Qb as V,S as f,Ta as ge,Tb as I,Ua as ye,V as _,Vb as Ce,W as oe,Z as le,_ as se,ba as l,eb as Se,fa as r,ga as i,gb as O,ha as d,ia as me,ib as U,ja as pe,jb as R,ka as z,la as c,ma as k,sb as te,ta as ue,tb as he,ua as a,ub as be,v as re}from"./chunk-Y6X5IISN.js";import{a as B,h as S}from"./chunk-ENRHZQ2S.js";var W=class p{constructor(m,t,e){this.fb=m;this.toast=t;this.serialKeyService=e;this.userForm=this.fb.group({otptype:[2,u.required],count:[1,[u.required,u.min(1),u.max(1e4)]],branch_cd:[void 0,u.required],bank_cd:[void 0,u.required],command:[3],from:[1],status:[0]}),this.userForm.get("otptype")?.valueChanges.subscribe(n=>{this.user&&this.setting&&this.serialKeyService.getLastMaxCount(this.setting.bankCode,this.user.branchName,this.userForm.get("otptype").value).then(o=>{this.lastMaxCount=o})})}user;setting;save=new C;cancel=new C;lastMaxCount;modalTitle="Generate Keys";userForm;eOtpType=P;dialogRef;userNotUnique=!1;ngOnChanges(){this.user&&this.userForm.get("branch_cd").setValue(this.user.branchName),this.setting&&this.userForm.get("bank_cd").setValue(this.setting.bankCode),this.user&&this.setting&&this.serialKeyService.getLastMaxCount(this.setting.bankCode,this.user.branchName,this.userForm.get("otptype").value).then(m=>{this.lastMaxCount=m})}onSave(){return S(this,null,function*(){let m=new $;try{m.show();let t=B({},this.userForm.value);t.from=this.lastMaxCount,t.to=+t.count+ +t.from,delete t.count,yield this.serialKeyService.generateKey(t),this.dialogRef.close(void 0),this.toast.success(`${this.userForm.get("count")?.value} key generated successfully.`)}catch(t){this.toast.error(t.msg)}finally{m.hide()}})}onCancel(){this.dialogRef.close(void 0),this.cancel.emit()}get formControls(){return this.userForm.controls}static \u0275fac=function(t){return new(t||p)(f(I),f(H),f(y))};static \u0275cmp=_({type:p,selectors:[["app-otp-serial-key-create-modal"]],inputs:{user:"user",setting:"setting"},outputs:{save:"save",cancel:"cancel"},standalone:!1,features:[L([D,y]),G],decls:24,vars:4,consts:[[1,"modal-content",3,"formGroup"],[1,"tsway-modal-header"],[1,"tsway-modal-title"],["type","button","aria-label","Close",1,"btn-close",3,"click"],[1,"tsway-modal-body"],[1,"row"],[1,"col-md"],["for","otptype",1,"form-label","small","mb-1"],["id","otptype","formControlName","otptype",1,"form-control"],[3,"ngValue"],["for","count",1,"form-label","small","mb-1"],["type","number","formControlName","count","id","count",1,"form-control"],[1,"tsway-modal-footer","d-flex","flex-row-reverse","justify-content-start"],[1,"btn","btn-primary",3,"click","disabled"],[1,"btn","btn-danger","me-2","text-white",3,"click"]],template:function(t,e){t&1&&(r(0,"form",0)(1,"div",1)(2,"h5",2),a(3,"Generate Key"),i(),r(4,"button",3),c("click",function(){return e.onCancel()}),i()(),r(5,"div",4)(6,"div",5)(7,"section",6)(8,"label",7),a(9,"Type"),i(),r(10,"select",8)(11,"option",9),a(12,"Card"),i(),r(13,"option",9),a(14,"Token"),i()()(),r(15,"section",6)(16,"label",10),a(17,"Number of Key to generate?"),i(),d(18,"input",11),i()()(),r(19,"div",12)(20,"button",13),c("click",function(){return e.onSave()}),a(21," Save "),i(),r(22,"button",14),c("click",function(){return e.onCancel()}),a(23," Cancel "),i()()()),t&2&&(l("formGroup",e.userForm),s(11),l("ngValue",e.eOtpType.Card),s(2),l("ngValue",e.eOtpType.Token),s(7),l("disabled",e.userForm.invalid))},dependencies:[w,q,V,K,T,x,F,E,M,N],styles:["[_nghost-%COMP%]{font-size:.875rem!important}"]})};var Y=class p{constructor(m,t,e){this.fb=m;this.toast=t;this.serialKeyService=e;this.form=this.fb.group({otptype:[2,u.required],branch_cd:[void 0,u.required],bank_cd:[void 0,u.required],command:[3],from:[1,[u.required,u.min(1)]],to:[1,[u.required,u.min(1),u.max(1e4)]],status:[1]}),this.form.get("otptype")?.valueChanges.subscribe(n=>{this.user&&this.setting&&this.serialKeyService.getLastMaxCount(this.setting.bankCode,this.user.branchName,this.form.get("otptype").value).then(o=>{this.lastMaxCount=o})})}startSequence=1;endSequence=1;user;setting;status=1;save=new C;cancel=new C;dialogRef;lastMaxCount;modalTitle="Generate Keys";form;eOtpType=P;eStatus=A;userNotUnique=!1;ngOnChanges(){this.user&&this.form.get("branch_cd").setValue(this.user.branchName),this.setting&&this.form.get("bank_cd").setValue(this.setting.bankCode),this.user&&this.setting&&this.serialKeyService.getLastMaxCount(this.setting.bankCode,this.user.branchName,this.form.get("otptype").value).then(m=>{this.lastMaxCount=m}),this.form.get("from")?.setValue(this.startSequence),this.form.get("to")?.setValue(this.endSequence),this.form.get("status")?.setValue(this.status)}onSave(){return S(this,null,function*(){let m=new $;try{let t;m.show();let e=B({},this.form.value);if(t=yield this.serialKeyService.get([{bankCode:O(e.bank_cd)},{branchCode:O(e.branch_cd)},{sequenceNumber:U(e.from)},{sequenceNumber:R(e.to)}]),t.length===0){this.toast.warning(`No data found in the range of [${e.from},${e.to}]`);return}let n;e.status===this.eStatus.Manufacturing?n=this.serialKeyService.sendForManufacturing(e.bank_cd,e.branch_cd,e.from,e.to):n=this.serialKeyService.markAsDelivered(e.bank_cd,e.branch_cd,e.from,e.to),yield n,t.forEach(o=>{o.status=this.status}),this.dialogRef.close(t),this.toast.success(`Serial Key from ${e.from} to ${e.to} updated to ${e.status===this.eStatus.Manufacturing?"Manufacturing":"Received"} successfully.`)}catch(t){this.toast.error(t.msg)}finally{m.hide()}})}onCancel(){this.dialogRef.close(void 0),this.cancel.emit()}get formControls(){return this.form.controls}static \u0275fac=function(t){return new(t||p)(f(I),f(H),f(y))};static \u0275cmp=_({type:p,selectors:[["app-otp-serial-key-create-modal"]],inputs:{startSequence:"startSequence",endSequence:"endSequence",user:"user",setting:"setting",status:"status"},outputs:{save:"save",cancel:"cancel"},standalone:!1,features:[L([y]),G],decls:33,vars:7,consts:[[1,"modal-content",3,"formGroup"],[1,"tsway-modal-header"],[1,"tsway-modal-title"],["type","button","aria-label","Close",1,"btn-close",3,"click"],[1,"tsway-modal-body"],[1,"row"],[1,"col-md-12"],["for","otptype",1,"form-label","small","mb-1"],["id","otptype","formControlName","otptype",1,"form-control"],[3,"ngValue"],["for","from",1,"form-label","small","mb-1"],["type","number","formControlName","from","id","from",1,"form-control"],["for","to",1,"form-label","small","mb-1"],["type","number","formControlName","to","id","to",1,"form-control"],["for","status",1,"form-label","small","mb-1","d-block"],[1,"form-control","d-block",3,"innerHTML"],[1,"tsway-modal-footer","d-flex","flex-row-reverse","justify-content-start"],[1,"btn","btn-primary",3,"click","disabled"],[1,"btn","btn-danger","me-2","text-white",3,"click"]],template:function(t,e){t&1&&(r(0,"form",0)(1,"div",1)(2,"h5",2),a(3,"Bulk Update"),i(),r(4,"button",3),c("click",function(){return e.onCancel()}),i()(),r(5,"div",4)(6,"div",5)(7,"section",6)(8,"label",7),a(9,"Type"),i(),r(10,"select",8)(11,"option",9),a(12,"Card"),i(),r(13,"option",9),a(14,"Token"),i()()(),r(15,"section",6)(16,"label",10),a(17,"Sequence Number Start"),i(),d(18,"input",11),i(),r(19,"section",6)(20,"label",12),a(21,"Sequence Number End"),i(),d(22,"input",13),i(),r(23,"section",6)(24,"span",14),a(25,"Status"),i(),d(26,"span",15),de(27,"serialNumberStatus"),i()()(),r(28,"div",16)(29,"button",17),c("click",function(){return e.onSave()}),a(30," Save "),i(),r(31,"button",18),c("click",function(){return e.onCancel()}),a(32," Cancel "),i()()()),t&2&&(l("formGroup",e.form),s(11),l("ngValue",e.eOtpType.Card),s(2),l("ngValue",e.eOtpType.Token),s(13),l("innerHTML",ce(27,5,e.status),ae),s(3),l("disabled",e.form.invalid))},dependencies:[w,q,V,K,T,x,F,E,M,N,_e],styles:["[_nghost-%COMP%]{font-size:.875rem!important}"]})};var Z=class p{constructor(m){this.fb=m;let t=new Q().date();this.filterForm=this.fb.group({type:[null],dateFrom:[t,u.required],dateTo:[t,u.required],status:[void 0],sequenceStart:[],sequenceEnd:[]}),this.dateFrom=this.filterForm.get("dateFrom"),this.dateTo=this.filterForm.get("dateTo")}filterChange=new C;filterForm;eSerialType=P;eStatusType=A;dateFrom;dateTo;onSubmit(){this.filterChange.emit({type:this.filterForm.get("type").value,dateTo:this.dateFrom.value?new Q(this.dateTo.value):void 0,dateFrom:this.dateTo.value?new Q(this.dateFrom.value):void 0,status:he(this.filterForm.get("status").value)?-1:this.filterForm.get("status").value,sequenceStart:this.filterForm.get("sequenceStart").value?this.filterForm.get("sequenceStart").value:void 0,sequenceEnd:this.filterForm.get("sequenceEnd").value?this.filterForm.get("sequenceEnd").value:void 0})}ngOnDestroy(){}static \u0275fac=function(t){return new(t||p)(f(I))};static \u0275cmp=_({type:p,selectors:[["app-serial-key-filterbar"]],outputs:{filterChange:"filterChange"},standalone:!1,decls:48,vars:11,consts:[[1,"filterbar","mb-3"],[1,"row","g-3","align-items-end",3,"formGroup"],[1,"col-md"],["for","type",1,"form-label","small","mb-1"],["id","type","formControlName","type",1,"form-control"],[3,"ngValue"],["for","sequenceStart",1,"form-label","small","mb-1"],["type","number","id","sequenceStart","formControlName","sequenceStart",1,"form-control"],["for","sequenceEnd",1,"form-label","small","mb-1"],["type","number","id","sequenceEnd","formControlName","sequenceEnd",1,"form-control"],["for","dateFrom",1,"form-label","small","mb-1"],["type","date","id","dateFrom","formControlName","dateFrom",1,"form-control"],["for","dateTo",1,"form-label","small","mb-1"],["type","date","id","dateTo","formControlName","dateTo",1,"form-control"],["for","status",1,"form-label","small","mb-1"],["id","status","formControlName","status",1,"form-control"],[1,"col-auto"],[1,"btn","btn-primary","w-100","d-flex","align-items-center","justify-content-center","gap-2",3,"click","disabled"],[1,"bi","bi-search"]],template:function(t,e){t&1&&(r(0,"div",0)(1,"form",1)(2,"div",2)(3,"label",3),a(4,"Type"),i(),r(5,"select",4)(6,"option",5),a(7,"All"),i(),r(8,"option",5),a(9,"Card"),i(),r(10,"option",5),a(11,"Token"),i()()(),r(12,"div",2)(13,"label",6),a(14,"Sequence Start"),i(),d(15,"input",7),i(),r(16,"div",2)(17,"label",8),a(18,"Sequence End"),i(),d(19,"input",9),i(),r(20,"div",2)(21,"label",10),a(22,"From*"),i(),d(23,"input",11),i(),r(24,"div",2)(25,"label",12),a(26,"To*"),i(),d(27,"input",13),i(),r(28,"div",2)(29,"label",14),a(30,"Status"),i(),r(31,"select",15)(32,"option",5),a(33,"All"),i(),r(34,"option",5),a(35,"Created"),i(),r(36,"option",5),a(37,"In Production"),i(),r(38,"option",5),a(39,"Received"),i(),r(40,"option",5),a(41,"Assigned"),i(),r(42,"option",5),a(43,"Inactive"),i()()(),r(44,"div",16)(45,"button",17),c("click",function(){return e.onSubmit()}),d(46,"i",18),a(47," Search "),i()()()()),t&2&&(s(),l("formGroup",e.filterForm),s(5),l("ngValue",null),s(2),l("ngValue",e.eSerialType.Card),s(2),l("ngValue",e.eSerialType.Token),s(22),l("ngValue",null),s(2),l("ngValue",e.eStatusType.Created),s(2),l("ngValue",e.eStatusType.Manufacturing),s(2),l("ngValue",e.eStatusType.Delivered),s(2),l("ngValue",e.eStatusType.Assigned),s(2),l("ngValue",e.eStatusType.Void),s(3),l("disabled",e.filterForm.invalid))},dependencies:[w,q,V,K,T,x,F,E,M,N],encapsulation:2})};function qe(p,m){if(p&1){let t=z();me(0),r(1,"app-otp-serial-key-table",14),c("sendForManufacturingAction",function(n){h(t);let o=k();return b(o.onSendForManufacturing(n))})("markAsDeliveredAction",function(n){h(t);let o=k();return b(o.onMarkAsDelivered(n))}),i(),pe()}if(p&2){let t=k();s(),l("models",t.models)}}function Ve(p,m){if(p&1){let t=z();r(0,"div",15)(1,"app-paginator",16),c("pageChange",function(n){h(t);let o=k();return b(o.onPageChange(n))})("pageSizeChange",function(n){h(t);let o=k();return b(o.onPageSizeChange(n))}),i()()}if(p&2){let t=k();s(),l("pageSize",t.paginationOption.pageSize)("total",t.paginationOption.total)("startPage",1)("totalNotKnown",!1)}}function Ie(p,m){p&1&&(r(0,"div",17)(1,"div"),d(2,"i",18),r(3,"p",4),a(4,"Key records not found."),i()()())}var ee=class p extends ke{constructor(t,e,n,o){super(o);this.authService=e;this.settingService=n;this.modelService=t}setting;user;hasSearched=!1;startSequence=1;endSequence=1;getFilterParams(){let t=[],e=this.modelFilters;return e.type&&t.push({otpType:O(e.type)}),Number(e.status)>-1&&t.push({status:O(e.status)}),e.dateFrom&&t.push({createdDate:U(e.dateFrom.date(!0))}),e.dateTo&&t.push({createdDate:R(e.dateTo.date(!1))}),e.sequenceStart&&t.push({sequenceNumber:U(e.sequenceStart)}),e.sequenceEnd&&t.push({sequenceNumber:R(e.sequenceEnd)}),t.push({bankCode:O(this.setting.bankCode)}),t.push({branchCode:O(this.user.branchName)}),t}ngOnInit(){this.settingService.find().then(t=>{this.setting=t}),this.user=this.authService.authUser()}applyFilters(){return S(this,null,function*(){this.hasSearched=!0,this.paginationOption.total=yield this.modelService.getCount(this.getFilterParams()),yield this.loadModels(!0)})}openDialog(t){return S(this,null,function*(){(yield this.dialog.open(W,{user:this.user,setting:this.setting},{width:"35%"})).closed.subscribe(n=>{})})}loadModels(t){return super.loadModels(t).then(e=>(e.length>0&&(this.startSequence=e[0].sequenceNumber,this.endSequence=e[e.length-1].sequenceNumber),e))}onPageChange(t){this.paginationOption.currentPage=t,this.loadModels(!0)}onPageSizeChange(t){this.paginationOption.pageSize=t}onSendForManufacturing(t){return S(this,null,function*(){if(yield this.alert.show("Confirm Action","Are you sure you want to send these items for manufacturing?","primary")){let n=!1,o=te(t.map(g=>g.sequenceNumber));for(let g of o)try{yield this.modelService.sendForManufacturing(this.setting.bankCode,this.user.branchName,g.start,g.end),this.loadModels().then(),n=!0}catch{n=!1,this.toast.error("Update status change failed.")}n&&this.downloadKeySerial(t)}})}onMarkAsDelivered(t){return S(this,null,function*(){if(yield this.alert.show("Confirm Action","Are you sure you want to send these items as received?","primary")){let n=te(t.map(o=>o.sequenceNumber));for(let o of n)try{yield this.modelService.markAsDelivered(this.setting.bankCode,this.user.branchName,o.start,o.end),this.loadModels().then()}catch{this.toast.error("Update status change failed.")}}})}downloadKeySerial(t){let e=[];e.push("SerialNumber,OtpKey"),t.forEach(j=>{let Me=be(j.bankCode,j.branchCode,j.sequenceNumber+"");e.push(`${Me},${j.otpKey}`)});let n=e.join(`
`),o=new Blob([n],{type:"text/csv;charset=utf-8;"}),g=window.URL.createObjectURL(o),v=document.createElement("a");v.href=g,v.setAttribute("download","otp-keys.csv"),document.body.appendChild(v),v.click(),document.body.removeChild(v),window.URL.revokeObjectURL(g)}onBulkUpdateClick(){return S(this,null,function*(){let t=this.getBulkUpdateDisableState().allCreated?1:2;(yield this.dialog.open(Y,{status:t,user:this.user,setting:this.setting,startSequence:this.startSequence,endSequence:this.endSequence},{width:"30%"})).closed.subscribe(n=>{n.length>0&&(this.loadModels(!0).then(),t===1&&this.downloadKeySerial(n))})})}downloadCSVForSearchResult(){return S(this,null,function*(){this.models.length>0&&this.downloadKeySerial(this.models)})}getBulkUpdateDisableState(){if(this.models.length===0)return{allCreated:!1,allManufacturing:!1,disabled:!0};let t=this.models.every(n=>n.status===0),e=this.models.every(n=>n.status===1);return this.modelFilters.status===0&&t?{allCreated:!0,allManufacturing:!1,disabled:!1}:this.modelFilters.status===1&&e?{allCreated:!1,allManufacturing:!0,disabled:!1}:{allCreated:!1,allManufacturing:!1,disabled:!0}}static \u0275fac=function(e){return new(e||p)(f(y),f(ve),f(D),f(ne))};static \u0275cmp=_({type:p,selectors:[["app-serial-key"]],standalone:!1,features:[le],decls:20,vars:5,consts:[["button",""],["noData",""],[1,"container-fluid","py-4","d-flex","flex-column","vh-100"],[1,"d-flex","justify-content-between","align-items-center","mb-4"],[1,"mb-0"],[1,"btn","btn-danger","text-white",3,"click"],[1,"bi","bi-plus-lg","me-1"],[3,"filterChange"],[1,"d-flex","justify-content-end","mb-2"],["role","button",1,"btn","btn-small","btn-link","text-muted","small","text-decoration-none",3,"click","disabled"],[1,"bi","bi-journals","me-1"],[1,"bi","bi-download","me-1"],[4,"ngIf","ngIfElse"],["class","mb-4 fixed",4,"ngIf"],[3,"sendForManufacturingAction","markAsDeliveredAction","models"],[1,"mb-4","fixed"],[3,"pageChange","pageSizeChange","pageSize","total","startPage","totalNotKnown"],[1,"d-flex","justify-content-center","align-items-center","h-100","text-muted","text-center","px-4"],[1,"bi","bi-search","display-6","d-block","mb-2"]],template:function(e,n){if(e&1){let o=z();r(0,"div",2)(1,"div",3)(2,"h2",4),a(3,"OTP Keys"),i(),r(4,"button",5,0),c("click",function(){return h(o),b(n.addModel())}),d(6,"i",6),a(7,"Create Key "),i()(),r(8,"app-serial-key-filterbar",7),c("filterChange",function(v){return h(o),b(n.onFilterChange(v))}),i(),r(9,"div",8)(10,"button",9),c("click",function(){return h(o),b(n.onBulkUpdateClick())}),d(11,"i",10),a(12," Bulk Update "),i(),r(13,"button",9),c("click",function(){return h(o),b(n.downloadCSVForSearchResult())}),d(14,"i",11),a(15," Download CSV"),i()(),se(16,qe,2,1,"ng-container",12)(17,Ve,2,4,"div",13)(18,Ie,5,0,"ng-template",null,1,fe),i()}if(e&2){let o=ue(19);s(10),l("disabled",n.getBulkUpdateDisableState().disabled),s(3),l("disabled",n.models.length===0),s(3),l("ngIf",n.models.length>0)("ngIfElse",o),s(),l("ngIf",n.hasSearched)}},dependencies:[Oe,ge,J,Z],encapsulation:2})};var De=[{path:"",component:ee}],Te=class p{static \u0275fac=function(t){return new(t||p)};static \u0275mod=oe({type:p});static \u0275inj=re({providers:[D,y],imports:[Fe,ye,Se.forChild(De),Ce,Ke,J]})};export{Te as OtpSerialKeyModule};
